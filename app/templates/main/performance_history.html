{% extends "base.html" %}

{% block body %}
	<div class="container-fluid py-4">

	<div class="d-flex ">
		<ul class="me-auto nav nav-pills m-2" id="performance-tabs" role="tablist">
			<li class="nav-item pill">
				<a class="nav-link" id="ind-perf-tab" href="#" data-toggle="tab"
				   data-target=".individualPerf, .studentIdFilter, .filterSelect, .studentFilter">Individual-level</a>
			</li>
			<li class="nav-item pill active">
				<a class="nav-link active" id="group-perf-tab" href="#group-level" data-toggle="tab"
				   data-target=".groupPerf, .filterSelect, .perfGrouping">Group-level</a>
			</li>
		</ul>

		<div class="d-flex ">
			<div class="input-group mb-4 mt-2 tab-pane fade studentFilter">
				<input id="perf-studentId-input" type="number" class="form-control" placeholder="Matrikelnummer"
					   aria-label="Search Matrikelnummer" aria-describedby="Matrikelnummer">
				<button class="btn btn-outline-secondary mb-0" type="button" id="perf-studentId-btn">
					<i class="fa fa-search"></i>
				</button>
			</div>

			<div class="input-group mb-3 mt-3 tab-pane fade show active perfGrouping">
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2"
						   value="option2" checked>
					<label class="form-check-label" for="inlineRadio2">Degree</label>
				</div>
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3"
						   value="option3" disabled>
					<label class="form-check-label" for="inlineRadio3">Studies</label>
				</div>
			</div>

		</div>
	</div>

	<div class="row">
		<div class="col-12 tab-content">
			{# Individual Tab#}
			<div class="card mb-4 tab-pane fade individualPerf" role="tabpanel"
				 aria-labelledby="individual-tab">
				<div class="card-header pb-0">

				</div>
				<div class="card-body px-0 pt-0 pb-2">
					<div class="container" id="individual-perf">

						<div class="d-flex justify-content-center align-items-center perfLoading fade">
							<div class="spinner-border text-secondary" role="status">
								<span class="sr-only">Loading...</span>
							</div>
						</div>


						<div class="chart">
							<canvas id="individual-perf-chart" class="chart-canvas" height="100px"></canvas>
						</div>

					</div>
				</div>
			</div>
			{# Group Tab#}
			<div class="card mb-4 tab-pane fade show active groupPerf" role="tabpanel" aria-labelledby="group-tab">
				<div class="card-header pb-0">

				</div>
				<div class="card-body px-0 pt-0 pb-2">
					<div class="container" id="group-perf">
						<div class="d-flex justify-content-center perfLoading">
							<div class="spinner-border text-secondary" role="status">
								<span class="sr-only">Loading...</span>
							</div>
						</div>
						<div class="chart">
							<canvas id="group-perf-chart" class="chart-canvas" height="100px"></canvas>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
        let element = document.getElementById("performanceLink");
        element.classList.add("active");
        element = document.getElementById("performanceLinkMobile");
        element.classList.add("active");

        // Performance Tabs
        $('#performance-tabs a').on('click', function (e) {
            e.preventDefault()
            $(this).tab('show')
        })

        $('#performance-tabs a[data-toggle="tab"]').on('show.bs.tab', function (e) {
            let target = $(e.target).data('target');
            $('.tab-pane').not(target).removeClass('active show');
            $(target)
                .addClass('active show')
        });

        // Ajax Individual Performance
        var chart = null;
        var groupChart = null;

        function fetchIndividualPerformance(studentId) {
            const url = "/individual_performance/" + studentId;
            const loadingDiv = $('.perfLoading');
            $.ajax({
                url: url,
                method: "GET",
                beforeSend: function () {
                    // Remove the "fade" class to show the loading <div>
                    loadingDiv.removeClass('fade');
                },
                success: function (data) {
                    // Parse the data received from the backend
                    const jsonData = JSON.parse(data);

                    // Extract the necessary columns from the data
                    const numSemesterData = jsonData.data.map(function (item) {
                        return item.Num_Semester;
                    });
                    const ectsData = jsonData.data.map(function (item) {
                        return item.ECTS;
                    });
                    const studentMajor = jsonData.major;
                    const studentDegree = jsonData.degree;


                    // Check if the chart instance already exists
                    if (chart) {
                        // Update the chart's data
                        chart.data.labels = numSemesterData;
                        chart.data.datasets[0].data = ectsData;
                        chart.options.plugins.title.text = 'Matrikelnummer: ' + studentId;
                        chart.options.plugins.subtitle.text = studentMajor + ' (' + studentDegree + ')';

                        // Redraw the chart
                        chart.update();
                    } else {

                        // Create the chart using Charts.js
                        const ctx = document.getElementById('individual-perf-chart').getContext('2d');

                        chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: numSemesterData,
                                datasets: [{
                                    label: 'ECTS',
                                    data: ectsData,
                                    borderColor: '#006ab3',
                                    backgroundColor: '#006ab3',
                                    borderWidth: 3,
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Cumulative ECTS'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Semester'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Matrikelnummer: ' + studentId
                                    },
                                    subtitle: {
                                        display: true,
                                        text: studentMajor + ' (' + studentDegree + ')'
                                    },

                                }

                            }
                        });
                    }
                    loadingDiv.addClass('fade');
                },
                error: function () {
                    console.error("Failed to fetch data from the backend.");
                    loadingDiv.addClass('fade');
                }
            });
        }

        $(document).ready(function () {
            const studentId = 0;
            fetchIndividualPerformance(studentId);

            $('#perf-studentId-btn').click(function () {

                const studentId = $('#perf-studentId-input').val();

                fetchIndividualPerformance(Number(studentId));
            });
        });

        // Ajax Group Performance

        function fetchGroupPerformance(groupId) {

            const url = "/group_performance/" + groupId;
            const loadingDiv = $('.perfLoading');

            $.ajax({
                url: url,
                method: "GET",
                beforeSend: function () {
                    // Remove the "fade" class to show the loading <div>
                    loadingDiv.removeClass('fade');
                },
                success: function (data) {
                    // Parse the data received from the backend
                    const jsonData = JSON.parse(data);

                    var masterData = jsonData.filter(function (item) {
                        return item.Degree === 'Master';
                    });

                    // Extract the necessary columns for Master degree
                    var masterNumSemesterData = masterData.map(function (item) {
                        return item.Num_Semester;
                    });
                    var masterEctsData = masterData.map(function (item) {
                        return item.ECTS;
                    });

                    // Filter the data for Bachelor degree
                    const bachelorData = jsonData.filter(function (item) {
                        return item.Degree === 'Bachelor';
                    });

                    // Extract the necessary columns for Bachelor degree
                    const bachelorNumSemesterData = bachelorData.map(function (item) {
                        return item.Num_Semester;
                    });
                    const bachelorEctsData = bachelorData.map(function (item) {
                        return item.ECTS;
                    });

                    // Check if the chart instance already exists
                    if (groupChart) {
                        // Update the chart's data
                        groupChart.data.labels = bachelorNumSemesterData;
                        groupChart.data.datasets[0].data = masterEctsData;
                        groupChart.data.datasets[1].data = bachelorEctsData;

                        // Redraw the chart
                        groupChart.update();
                    } else {

                        // Create the chart using Charts.js
                        const ctx = document.getElementById('group-perf-chart').getContext('2d');
                        groupChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: bachelorNumSemesterData,
                                datasets: [{
                                    label: 'Master',
                                    data: masterEctsData,
                                    borderColor: '#006ab3',
                                    backgroundColor: '#006ab3',
                                    borderWidth: 3,
                                }, {
                                    label: 'Bachelor',
                                    data: bachelorEctsData,
                                    borderColor: '#ff7f50',
                                    backgroundColor: '#ff7f50',
                                    borderWidth: 3,
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'AVG. ECTS'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'Semester'
                                        }
                                    }
                                }
                            }
                        });
                    }

                    loadingDiv.addClass('fade');
                },
                error: function () {
                    console.error("Failed to fetch data from the backend.");
                    loadingDiv.addClass('fade');
                }
            });
        }


        $(document).ready(function () {
                const groupId = 'degree';
                fetchGroupPerformance(groupId);

                //  $('#perf-groupId-btn').click(function() {
                //     
                //     const groupId = $('#perf-groupId-input').val();
                //
                //     fetchGroupPerformance(groupId);
                // });
            }
        );
	</script>
{% endblock %}
